<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>3D 模型展示（手槍）</title>

    <link rel="preload" href="手槍/scene.gltf" as="fetch" crossorigin="anonymous" />

    <style>
      :root { color-scheme: dark; }
      html, body {
        height: 100%;
        margin: 0;
        background: #0f1115;
        overflow: hidden;
        font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI",
                     Roboto, "Noto Sans TC", "PingFang TC", "Heiti TC",
                     "Microsoft JhengHei", Arial, sans-serif;
      }
      model-viewer {
        width: 100vw;
        height: 100vh;
        background: radial-gradient(120% 120% at 50% 0%, #1b1f2a 0%, #0a0b0e 100%);
      }
      .hud {
        position: fixed;
        left: 12px;
        bottom: 12px;
        display: flex;
        gap: 8px;
        align-items: center;
        padding: 8px 10px;
        background: rgba(0,0,0,.45);
        border: 1px solid rgba(255,255,255,.08);
        border-radius: 12px;
        backdrop-filter: blur(6px);
        z-index: 10;
      }
      .hud button, .hud select {
        all: unset;
        padding: 8px 10px;
        border-radius: 10px;
        background: rgba(255,255,255,.1);
        cursor: pointer;
        font-size: 14px;
      }
      .hud button:hover, .hud select:hover { background: rgba(255,255,255,.18); }

      /* 熱區樣式：平時幾乎透明；定位模式會變紅色 */
      .hotspot {
        background: rgba(255,0,0,0.001);
        border: none;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        cursor: pointer;
      }
      .hotspot.debug {
        background: rgba(255,0,0,0.55);
        outline: 2px solid rgba(255,255,255,.7);
      }
    </style>

    <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
    <script nomodule src="https://unpkg.com/@google/model-viewer/dist/model-viewer-legacy.js"></script>
  </head>

  <body>
    <model-viewer
      id="viewer"
      src="手槍/scene.gltf"
      alt="Pistol 3D Model"
      ar ar-modes="webxr scene-viewer quick-look"
      camera-controls
      autoplay
      auto-rotate
      rotation-per-second="30deg"
      animation-loop
      environment-image="neutral"
      exposure="1.15"
      shadow-intensity="1"
      shadow-softness="0.6"
      camera-orbit="0deg 65deg 110%"
      field-of-view="35deg"
      interaction-prompt="auto"
      touch-action="pan-y"
    >
      <div slot="poster" style="width:100%;height:100%;display:grid;place-items:center;color:#aaa;">
        載入模型中…
      </div>

      <!-- 扳機熱區：先給一個大約位置；之後用 F2 對位 -->
      <button
        id="hot-fire"
        class="hotspot"
        slot="hotspot-fire"
        data-position="0.12 -0.05 0.08"
        data-normal="0 0 1"
        title="前往影片"
        onclick="window.open('https://www.youtube.com/watch?v=wEmguQoIHZs','_blank')"
      ></button>
    </model-viewer>

    <div class="hud">
      <button id="playPause">暫停</button>
      <label style="opacity:.8">動畫：</label>
      <select id="animSelect"></select>
      <span id="modeTip" style="margin-left:8px;opacity:.75;">F2：切換定位模式</span>
    </div>

    <script>
      const mv   = document.getElementById('viewer');
      const btn  = document.getElementById('playPause');
      const sel  = document.getElementById('animSelect');
      const fire = document.getElementById('hot-fire');
      const tip  = document.getElementById('modeTip');

      let placing = false; // 是否為定位模式
      let wasAutoRotating = true;

      mv.addEventListener('load', () => {
        const animations = mv.availableAnimations || [];
        sel.innerHTML = '';
        if (animations.length === 0) {
          const opt = document.createElement('option');
          opt.textContent = '（無動畫）';
          opt.value = '';
          sel.appendChild(opt);
          sel.disabled = true;
        } else {
          animations.forEach((name, i) => {
            const opt = document.createElement('option');
            opt.textContent = name || `Animation ${i+1}`;
            opt.value = name;
            sel.appendChild(opt);
          });
          mv.animationName = animations[0];
          sel.value = animations[0];
          sel.disabled = false;
        }
      });

      sel.addEventListener('change', () => {
        mv.animationName = sel.value;
        if (mv.paused) mv.play();
      });

      btn.addEventListener('click', () => {
        if (mv.paused) {
          mv.play();
          btn.textContent = '暫停';
        } else {
          mv.pause();
          btn.textContent = '播放';
        }
      });

      // F2：切換定位模式（進入時暫停自轉，退出時恢復）
      window.addEventListener('keydown', (e) => {
        if (e.key === 'F2') {
          placing = !placing;
          fire.classList.toggle('debug', placing);
          if (placing) {
            wasAutoRotating = mv.autoRotate;
            mv.autoRotate = false;
            tip.textContent = '定位模式：點模型貼上熱區（F2 結束）';
          } else {
            mv.autoRotate = wasAutoRotating;
            tip.textContent = 'F2：切換定位模式';
          }
        }
      });

      // 定位：點擊模型→取得座標→更新熱區（一定要呼叫 updateHotspot）
      mv.addEventListener('click', (event) => {
        if (!placing) return;
        const hit = mv.positionAndNormalFromPoint(event.clientX, event.clientY);
        if (!hit) return; // 沒點到模型，直接跳過
        const {position, normal} = hit;

        // 1) 寫回屬性（方便之後保存為靜態值）
        fire.dataset.position = `${position.x} ${position.y} ${position.z}`;
        fire.dataset.normal   = `${normal.x} ${normal.y} ${normal.z}`;

        // 2) 立即更新熱區（這步驟很關鍵）
        mv.updateHotspot({
          name: 'hotspot-fire',
          position,
          normal
        });

        console.log('hotspot position:', fire.dataset.position);
        console.log('hotspot normal  :', fire.dataset.normal);
      });

      if (location.protocol === 'file:') {
        console.warn('請用本機伺服器開啟（VS Code Live Server 或 python -m http.server），避免 CORS 問題。');
      }
    </script>
  </body>
</html>
